{% extends "base.html" %}

{% block title %}Paramètres - Gestion des modèles IA{% endblock %}

{% block extra_css %}
<style>
    .model-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .model-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .model-card.active {
        border-left-color: #3498db;
        background-color: rgba(52, 152, 219, 0.05);
    }
    .parameter-slider {
        width: 100%;
    }
    .model-size-badge {
        font-size: 0.8rem;
    }
    .model-info {
        font-size: 0.9rem;
    }
    .model-info .bi {
        margin-right: 5px;
    }
    .model-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .model-status.ready {
        background-color: #2ecc71;
    }
    .model-status.downloading {
        background-color: #f39c12;
    }
    .model-status.error {
        background-color: #e74c3c;
    }
    .param-description {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .model-details {
        font-size: 0.9rem;
        margin-top: 10px;
    }
    .model-tags {
        margin-top: 5px;
    }
    .model-tag {
        font-size: 0.75rem;
        margin-right: 5px;
    }
    .current-value {
        font-weight: 600;
        margin-left: 8px;
    }
    .refresh-btn {
        transition: transform 0.5s ease;
    }
    .refresh-btn.rotating {
        transform: rotate(360deg);
    }
    .system-info-card {
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
    }
    .advanced-options {
        display: none;
    }
    .advanced-options.show {
        display: block;
    }
    .advanced-toggle {
        cursor: pointer;
        user-select: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">Paramètres</li>
        </ol>
    </nav>
    
    <h1 class="mb-4">
        <i class="bi bi-gear"></i> Paramètres
    </h1>
    
    <div class="row">
        <div class="col-md-3">
            <div class="list-group mb-4">
                <a href="#ollama-settings" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                    <i class="bi bi-robot"></i> Modèles Ollama
                </a>
                <a href="#general-settings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-sliders"></i> Général
                </a>
                <a href="#data-settings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-database"></i> Données
                </a>
                <a href="#appearance-settings" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-palette"></i> Apparence
                </a>
                <a href="#system-info" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="bi bi-info-circle"></i> Informations système
                </a>
            </div>
            
            <div class="card system-info-card mb-4">
                <div class="card-body">
                    <h6><i class="bi bi-cpu"></i> Système</h6>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-hdd"></i> Stockage : <span id="disk-usage">Chargement...</span>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-memory"></i> Mémoire : <span id="memory-usage">Chargement...</span>
                    </div>
                    <div class="small text-muted">
                        <i class="bi bi-gpu-card"></i> GPU : <span id="gpu-status">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Onglet Modèles Ollama -->
                <div class="tab-pane fade show active" id="ollama-settings">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Modèles d'IA disponibles</h5>
                            <div>
                                <button id="refresh-models-btn" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise refresh-btn"></i> Actualiser
                                </button>
                                <a href="https://ollama.com/library" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                    <i class="bi bi-box-arrow-up-right"></i> Bibliothèque Ollama
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" id="models-loading">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Chargement des modèles disponibles...
                            </div>
                            
                            <div class="alert alert-danger d-none" id="models-error">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Impossible de se connecter au serveur Ollama. Vérifiez que le service est démarré et accessible.
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-danger" id="check-ollama-connection">
                                        <i class="bi bi-arrow-clockwise"></i> Vérifier la connexion
                                    </button>
                                    <a href="https://ollama.com/download" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                        <i class="bi bi-download"></i> Télécharger Ollama
                                    </a>
                                </div>
                            </div>
                            
                            <div id="models-list" class="d-none">
                                <!-- La liste des modèles sera injectée ici -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm mb-4" id="model-parameters-card">
                        <div class="card-header">
                            <h5 class="mb-0">Paramètres du modèle <span id="current-model-name">-</span></h5>
                        </div>
                        <div class="card-body">
                            <form id="model-parameters-form">
                                <input type="hidden" id="selected-model" name="model_name" value="">
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="temperature-slider" class="form-label">
                                            Température <span class="current-value" id="temperature-value">0.7</span>
                                        </label>
                                        <input type="range" class="form-range parameter-slider" id="temperature-slider" 
                                               name="temperature" min="0" max="2" step="0.05" value="0.7">
                                        <div class="param-description">
                                            Contrôle la créativité des réponses. Une valeur plus basse produit des réponses plus déterministes,
                                            une valeur plus haute produit des réponses plus variées et créatives.
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="top-p-slider" class="form-label">
                                            Top P <span class="current-value" id="top-p-value">0.9</span>
                                        </label>
                                        <input type="range" class="form-range parameter-slider" id="top-p-slider" 
                                               name="top_p" min="0" max="1" step="0.05" value="0.9">
                                        <div class="param-description">
                                            Contrôle la diversité des réponses en limitant les tokens aux plus probables.
                                            Une valeur plus basse est plus conservatrice.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="max-tokens-slider" class="form-label">
                                            Nombre maximal de tokens <span class="current-value" id="max-tokens-value">800</span>
                                        </label>
                                        <input type="range" class="form-range parameter-slider" id="max-tokens-slider" 
                                               name="max_tokens" min="100" max="4096" step="100" value="800">
                                        <div class="param-description">
                                            Limite la longueur maximale de la réponse générée.
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="context-window-slider" class="form-label">
                                            Taille de la fenêtre de contexte <span class="current-value" id="context-window-value">4096</span>
                                        </label>
                                        <input type="range" class="form-range parameter-slider" id="context-window-slider" 
                                               name="context_size" min="1024" max="16384" step="1024" value="4096">
                                        <div class="param-description">
                                            Définit la taille maximale du contexte pris en compte par le modèle.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="advanced-toggle text-primary mb-3">
                                    <i class="bi bi-chevron-down"></i> Paramètres avancés
                                </div>
                                
                                <div class="advanced-options">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="top-k-slider" class="form-label">
                                                Top K <span class="current-value" id="top-k-value">40</span>
                                            </label>
                                            <input type="range" class="form-range parameter-slider" id="top-k-slider" 
                                                   name="top_k" min="0" max="100" step="1" value="40">
                                            <div class="param-description">
                                                Limite le choix aux K tokens les plus probables à chaque étape.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="repeat-penalty-slider" class="form-label">
                                                Pénalité de répétition <span class="current-value" id="repeat-penalty-value">1.1</span>
                                            </label>
                                            <input type="range" class="form-range parameter-slider" id="repeat-penalty-slider" 
                                                   name="repeat_penalty" min="1" max="2" step="0.05" value="1.1">
                                            <div class="param-description">
                                                Pénalise la répétition de tokens. Une valeur plus élevée réduit les répétitions.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="presence-penalty-slider" class="form-label">
                                                Pénalité de présence <span class="current-value" id="presence-penalty-value">0</span>
                                            </label>
                                            <input type="range" class="form-range parameter-slider" id="presence-penalty-slider" 
                                                   name="presence_penalty" min="-2" max="2" step="0.1" value="0">
                                            <div class="param-description">
                                                Pénalise les nouveaux tokens en fonction de leur présence dans le texte existant.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="frequency-penalty-slider" class="form-label">
                                                Pénalité de fréquence <span class="current-value" id="frequency-penalty-value">0</span>
                                            </label>
                                            <input type="range" class="form-range parameter-slider" id="frequency-penalty-slider" 
                                                   name="frequency_penalty" min="-2" max="2" step="0.1" value="0">
                                            <div class="param-description">
                                                Pénalise les nouveaux tokens en fonction de leur fréquence dans le texte existant.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="mirostat-slider" class="form-label">
                                                Mode Mirostat <span class="current-value" id="mirostat-value">0</span>
                                            </label>
                                            <input type="range" class="form-range parameter-slider" id="mirostat-slider" 
                                                   name="mirostat" min="0" max="2" step="1" value="0">
                                            <div class="param-description">
                                                Algorithme de contrôle de la surprise: 0 = désactivé, 1 = Mirostat, 2 = Mirostat 2.0
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="seed-input" class="form-label">
                                                Graine aléatoire (seed)
                                            </label>
                                            <input type="number" class="form-control" id="seed-input" 
                                                   name="seed" min="-1" value="-1">
                                            <div class="param-description">
                                                Définit la graine aléatoire pour la génération. -1 = aléatoire.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between">
                                            <button type="submit" class="btn btn-primary" id="save-parameters-btn">
                                                <i class="bi bi-save"></i> Enregistrer les paramètres
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="reset-parameters-btn">
                                                <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Télécharger un nouveau modèle</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Vous pouvez installer un nouveau modèle depuis la bibliothèque Ollama en utilisant le formulaire ci-dessous
                                ou via la commande <code>ollama pull nom_du_modèle:tag</code> en ligne de commande.
                            </div>
                            
                            <form id="pull-model-form" class="row g-3">
                                <div class="col-md-8">
                                    <label for="model-name-input" class="form-label">Nom du modèle</label>
                                    <input type="text" class="form-control" id="model-name-input" 
                                           placeholder="ex: llama3, mistral, phi3" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="model-tag-input" class="form-label">Tag (optionnel)</label>
                                    <input type="text" class="form-control" id="model-tag-input" 
                                           placeholder="ex: latest, 8b, instruct">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary" id="pull-model-btn">
                                        <i class="bi bi-cloud-download"></i> Télécharger le modèle
                                    </button>
                                </div>
                            </form>
                            
                            <div class="mt-3 d-none" id="pull-progress-container">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 id="pull-model-status">Téléchargement en cours...</h6>
                                        <div class="progress mb-2">
                                            <div id="pull-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div class="small text-muted" id="pull-progress-details">
                                            Initialisation du téléchargement...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Autres onglets -->
                <div class="tab-pane fade" id="general-settings">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Paramètres généraux</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-secondary">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Cette section sera implémentée dans une future mise à jour.
                            </div>
                            
                            <form>
                                <div class="mb-3">
                                    <label for="app-language" class="form-label">Langue de l'interface</label>
                                    <select class="form-select" id="app-language">
                                        <option value="fr" selected>Français</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="api-url" class="form-label">URL de l'API Ollama</label>
                                    <input type="text" class="form-control" id="api-url" value="http://localhost:11434">
                                    <div class="form-text">L'URL par défaut est http://localhost:11434</div>
                                </div>
                                
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="history-enabled" checked>
                                    <label class="form-check-label" for="history-enabled">Activer l'historique des analyses</label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" disabled>
                                    <i class="bi bi-save"></i> Enregistrer
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="data-settings">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Paramètres des données</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-secondary">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Cette section sera implémentée dans une future mise à jour.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="appearance-settings">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Apparence</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-secondary">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Cette section sera implémentée dans une future mise à jour.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="system-info">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Informations système</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Version du logiciel</h6>
                                <div class="alert alert-light">
                                    <table class="table table-borderless table-sm mb-0">
                                        <tr>
                                            <td><strong>Version de l'application :</strong></td>
                                            <td>2.0.0</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Date de build :</strong></td>
                                            <td>24 mars 2025</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Framework :</strong></td>
                                            <td>Flask 3.0.0</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Python :</strong></td>
                                            <td>3.11.8</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Statut d'Ollama</h6>
                                <div class="alert alert-light">
                                    <table class="table table-borderless table-sm mb-0">
                                        <tr>
                                            <td><strong>Status :</strong></td>
                                            <td><span id="ollama-status-indicator">Vérification...</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Version :</strong></td>
                                            <td id="ollama-version">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>API URL :</strong></td>
                                            <td id="ollama-url">http://localhost:11434</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Modèles installés :</strong></td>
                                            <td id="models-count">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Ressources système</h6>
                                <div class="alert alert-light">
                                    <table class="table table-borderless table-sm mb-0">
                                        <tr>
                                            <td><strong>Utilisation CPU :</strong></td>
                                            <td id="cpu-usage">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Utilisation mémoire :</strong></td>
                                            <td id="ram-usage">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Espace disque :</strong></td>
                                            <td id="disk-space">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Espace disque Ollama :</strong></td>
                                            <td id="ollama-disk-space">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <button id="refresh-system-info" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i> Actualiser les informations
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des variables
    let availableModels = [];
    let currentModel = "";
    const parameterSliders = document.querySelectorAll('.parameter-slider');
    const modelsList = document.getElementById('models-list');
    const modelsLoading = document.getElementById('models-loading');
    const modelsError = document.getElementById('models-error');
    const ollamaUrl = 'http://localhost:11434';
    
    // Initialisation des sliders
    parameterSliders.forEach(slider => {
        const valueDisplay = document.getElementById(`${slider.id.replace('-slider', '')}-value`);
        if (valueDisplay) {
            valueDisplay.textContent = slider.value;
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }
    });
    
    // Toggle pour les options avancées
    const advancedToggle = document.querySelector('.advanced-toggle');
    const advancedOptions = document.querySelector('.advanced-options');
    
    if (advancedToggle && advancedOptions) {
        advancedToggle.addEventListener('click', function() {
            advancedOptions.classList.toggle('show');
            
            const icon = this.querySelector('.bi');
            if (advancedOptions.classList.contains('show')) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
                this.textContent = ' Masquer les paramètres avancés';
                this.prepend(icon);
            } else {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
                this.textContent = ' Paramètres avancés';
                this.prepend(icon);
            }
        });
    }
    
    // Fonction pour charger les modèles depuis l'API Ollama
    
    async function loadModels() {
        console.log("Chargement des modèles...");
        try {
            if (modelsLoading) modelsLoading.classList.remove('d-none');
            if (modelsError) modelsError.classList.add('d-none');
            if (modelsList) modelsList.classList.add('d-none');
            
            // Rotation du bouton d'actualisation
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.add('rotating');
            }
            
            // Ajouter des logs pour débogage
            console.log("URL de l'API:", '/api/models');
            
            const response = await fetch('/api/models');
            console.log("Réponse reçue:", response);
            console.log("Status:", response.status);
            
            const responseText = await response.text();
            console.log("Texte de la réponse:", responseText);
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status} - ${responseText}`);
            }
            
            // Convertir le texte en JSON
            const data = JSON.parse(responseText);
            console.log("Données reçues:", data);
            
            availableModels = data.models || [];
            
            // Mettre à jour les statistiques
            const modelsCountElement = document.getElementById('models-count');
            if (modelsCountElement) modelsCountElement.textContent = availableModels.length;
            
            const ollamaStatusElement = document.getElementById('ollama-status-indicator');
            if (ollamaStatusElement) ollamaStatusElement.innerHTML = '<span class="badge bg-success">En ligne</span>';
            
            // Rendre l'interface avec les modèles
            renderModelsList(availableModels);
            
            // Arrêter la rotation du bouton
            if (refreshBtn) {
                refreshBtn.classList.remove('rotating');
            }
            
            // Autres opérations inchangées...
        } catch (error) {
            console.error("Erreur lors du chargement des modèles:", error);
            
            if (modelsLoading) modelsLoading.classList.add('d-none');
            if (modelsError) {
                modelsError.classList.remove('d-none');
                // Ajouter le message d'erreur spécifique à l'élément modelsError
                const errorMsgElement = modelsError.querySelector('.error-message');
                if (errorMsgElement) {
                    errorMsgElement.textContent = error.message;
                } else {
                    modelsError.innerHTML += `<div class="mt-2 error-message">${error.message}</div>`;
                }
            }
            
            const ollamaStatusElement = document.getElementById('ollama-status-indicator');
            if (ollamaStatusElement) ollamaStatusElement.innerHTML = '<span class="badge bg-danger">Hors ligne</span>';
            
            // Arrêter la rotation du bouton
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                refreshBtn.classList.remove('rotating');
            }
        }
    }
    
    // Fonction pour mettre à jour l'affichage des informations système
    function updateSystemInfoDisplay(data) {
        if (!data) return;
        
        // Mettre à jour l'utilisation du CPU
        const cpuUsageElement = document.getElementById('cpu-usage');
        if (cpuUsageElement && data.cpu_usage) {
            cpuUsageElement.textContent = `${data.cpu_usage}%`;
        }
        
        // Mettre à jour l'utilisation de la mémoire
        const ramUsageElement = document.getElementById('ram-usage');
        if (ramUsageElement && data.memory) {
            const totalGB = (data.memory.total / (1024 * 1024 * 1024)).toFixed(1);
            const usedGB = ((data.memory.total - data.memory.available) / (1024 * 1024 * 1024)).toFixed(1);
            ramUsageElement.textContent = `${usedGB} GB / ${totalGB} GB (${data.memory.percent}%)`;
        }
        
        // Mettre à jour l'espace disque
        const diskSpaceElement = document.getElementById('disk-space');
        if (diskSpaceElement && data.disk) {
            const totalGB = (data.disk.total / (1024 * 1024 * 1024)).toFixed(1);
            const freeGB = (data.disk.free / (1024 * 1024 * 1024)).toFixed(1);
            diskSpaceElement.textContent = `${freeGB} GB libres / ${totalGB} GB (${data.disk.percent}% utilisé)`;
        }
        
        // Mettre à jour l'espace disque d'Ollama
        const ollamaDiskSpaceElement = document.getElementById('ollama-disk-space');
        if (ollamaDiskSpaceElement && data.ollama && data.ollama.directory_size) {
            const sizeGB = (data.ollama.directory_size / (1024 * 1024 * 1024)).toFixed(1);
            ollamaDiskSpaceElement.textContent = `${sizeGB} GB`;
        }
        
        // Mettre à jour le statut GPU
        const gpuStatusElement = document.getElementById('gpu-status');
        if (gpuStatusElement && data.gpu) {
            if (typeof data.gpu === 'string') {
                gpuStatusElement.textContent = data.gpu;
            } else if (typeof data.gpu === 'object') {
                gpuStatusElement.textContent = `${data.gpu.name} (${data.gpu.memory_used} / ${data.gpu.memory_total})`;
            }
        } else if (gpuStatusElement) {
            gpuStatusElement.textContent = "Non détecté";
        }
        
        // Mettre à jour les autres éléments dans la sidebar
        const diskUsageElement = document.getElementById('disk-usage');
        if (diskUsageElement && data.disk) {
            const totalGB = (data.disk.total / (1024 * 1024 * 1024)).toFixed(1);
            const freeGB = (data.disk.free / (1024 * 1024 * 1024)).toFixed(1);
            diskUsageElement.textContent = `${freeGB} GB / ${totalGB} GB`;
        }
        
        const memoryUsageElement = document.getElementById('memory-usage');
        if (memoryUsageElement && data.memory) {
            const totalGB = (data.memory.total / (1024 * 1024 * 1024)).toFixed(1);
            const usedGB = ((data.memory.total - data.memory.available) / (1024 * 1024 * 1024)).toFixed(1);
            memoryUsageElement.textContent = `${usedGB} GB / ${totalGB} GB`;
        }
        
        const gpuElement = document.getElementById('gpu-status');
        if (gpuElement && data.gpu) {
            if (typeof data.gpu === 'string') {
                gpuElement.textContent = data.gpu;
            } else if (typeof data.gpu === 'object') {
                gpuElement.textContent = data.gpu.name;
            }
        }
    }
    
    // Fonction pour rendre la liste des modèles
    function renderModelsList(models) {
        console.log("Rendu de la liste des modèles:", models);
        
        if (!modelsList) return;
        
        // Masquer le chargement et afficher la liste
        if (modelsLoading) modelsLoading.classList.add('d-none');
        modelsList.classList.remove('d-none');
        
        // Trier les modèles par nom
        models.sort((a, b) => a.name.localeCompare(b.name));
        
        // Vider la liste actuelle
        modelsList.innerHTML = '';
        
        // Vérifier s'il n'y a pas de modèles disponibles
        if (models.length === 0) {
            modelsList.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Aucun modèle n'est actuellement installé. Utilisez le formulaire ci-dessous pour télécharger un modèle.
                </div>
            `;
            return;
        }
        
        // Créer un élément pour chaque modèle
        models.forEach(model => {
            console.log("Traitement du modèle:", model);
            
            // Extraire le nom de base et le tag (version)
            let modelBase = model.name || model.model;
            let modelTag = 'latest';
            
            if (modelBase && modelBase.includes(':')) {
                const parts = modelBase.split(':');
                modelBase = parts[0];
                modelTag = parts[1];
            }
            
            // Déterminer la taille du modèle en GB
            let modelSize = "Inconnu";
            if (model.size) {
                modelSize = (model.size / (1024 * 1024 * 1024)).toFixed(1) + " GB";
            }
            
            // Déterminer la classe de couleur selon la taille
            let sizeClass = '';
            if (model.size) {
                const sizeGB = model.size / (1024 * 1024 * 1024);
                if (sizeGB < 5) sizeClass = 'bg-success';
                else if (sizeGB < 15) sizeClass = 'bg-warning';
                else sizeClass = 'bg-danger';
            }
            
            // Créer la carte du modèle
            const modelCard = document.createElement('div');
            modelCard.className = `card model-card mb-3 ${currentModel === model.name ? 'active' : ''}`;
            modelCard.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <span class="model-status ready"></span>
                            ${modelBase}
                        </h5>
                        <div>
                            <span class="badge ${sizeClass} model-size-badge me-2">${modelSize}</span>
                            <span class="badge bg-secondary model-tag">${modelTag}</span>
                        </div>
                    </div>
                    
                    <div class="model-details mt-2">
                        <div class="model-info">
                            <i class="bi bi-clock"></i> Digeste : <code>${model.digest ? model.digest.substring(0, 12) : 'N/A'}</code>
                        </div>
                        
                        <div class="model-info">
                            <i class="bi bi-calendar"></i> Dernière modification : ${model.modified_at ? new Date(model.modified_at).toLocaleString() : 'Inconnue'}
                        </div>
                    </div>
                    
                    <div class="model-tags">
                        ${getModelTags(modelBase)}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-sm btn-primary select-model-btn" data-model="${model.name || model.model}">
                            <i class="bi bi-check-circle"></i> Sélectionner
                        </button>
                        
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary model-info-btn" data-model="${model.name || model.model}">
                                <i class="bi bi-info-circle"></i> Info
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-model-btn" data-model="${model.name || model.model}">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modelsList.appendChild(modelCard);
            
            // Ajouter des écouteurs d'événements aux boutons
            const selectBtn = modelCard.querySelector('.select-model-btn');
            if (selectBtn) {
                selectBtn.addEventListener('click', function() {
                    console.log("Bouton sélectionner cliqué");
                    const modelName = this.getAttribute('data-model');
                    selectModel(modelName);
                });
            }
            
            const infoBtn = modelCard.querySelector('.model-info-btn');
            if (infoBtn) {
                infoBtn.addEventListener('click', function() {
                    console.log("Bouton info cliqué");
                    const modelName = this.getAttribute('data-model');
                    showModelInfo(modelName);
                });
            }
            
            const deleteBtn = modelCard.querySelector('.delete-model-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    console.log("Bouton supprimer cliqué");
                    const modelName = this.getAttribute('data-model');
                    deleteModel(modelName);
                });
            }
        });
    }
    
    // Fonction pour générer des tags pour le modèle en fonction de son nom
    function getModelTags(modelName) {
        const tags = [];
        const modelNameLower = modelName.toLowerCase();
        
        // Évaluer la taille/complexité du modèle
        if (modelNameLower.includes('7b') || modelNameLower.includes('7-b')) {
            tags.push('<span class="badge bg-success model-tag">7B</span>');
        } else if (modelNameLower.includes('13b') || modelNameLower.includes('13-b')) {
            tags.push('<span class="badge bg-warning model-tag">13B</span>');
        } else if (modelNameLower.includes('34b') || modelNameLower.includes('34-b')) {
            tags.push('<span class="badge bg-danger model-tag">34B</span>');
        } else if (modelNameLower.includes('70b') || modelNameLower.includes('70-b')) {
            tags.push('<span class="badge bg-danger model-tag">70B</span>');
        }
        
        // Détection de modèles populaires
        if (modelNameLower.includes('llama')) {
            tags.push('<span class="badge bg-primary model-tag">Llama</span>');
        } else if (modelNameLower.includes('mistral')) {
            tags.push('<span class="badge bg-primary model-tag">Mistral</span>');
        } else if (modelNameLower.includes('mixtral')) {
            tags.push('<span class="badge bg-primary model-tag">Mixtral</span>');
        } else if (modelNameLower.includes('phi')) {
            tags.push('<span class="badge bg-primary model-tag">Phi</span>');
        } else if (modelNameLower.includes('claude')) {
            tags.push('<span class="badge bg-primary model-tag">Claude</span>');
        } else if (modelNameLower.includes('gemma')) {
            tags.push('<span class="badge bg-primary model-tag">Gemma</span>');
        }
        
        // Type de modèle (instruct, chat, etc.)
        if (modelNameLower.includes('instruct')) {
            tags.push('<span class="badge bg-info model-tag">Instruct</span>');
        } else if (modelNameLower.includes('chat')) {
            tags.push('<span class="badge bg-info model-tag">Chat</span>');
        } else if (modelNameLower.includes('vision')) {
            tags.push('<span class="badge bg-info model-tag">Vision</span>');
        } else if (modelNameLower.includes('code')) {
            tags.push('<span class="badge bg-info model-tag">Code</span>');
        }
        
        // Si aucun tag n'a été ajouté, utiliser un tag générique
        if (tags.length === 0) {
            tags.push('<span class="badge bg-secondary model-tag">LLM</span>');
        }
        
        return tags.join(' ');
    }
    
    // Fonction pour sélectionner un modèle
    function selectModel(modelName) {
        console.log("Sélection du modèle:", modelName);
        
        // Mettre à jour la sélection actuelle
        currentModel = modelName;
        const selectedModelInput = document.getElementById('selected-model');
        if (selectedModelInput) selectedModelInput.value = modelName;
        
        const currentModelNameSpan = document.getElementById('current-model-name');
        if (currentModelNameSpan) currentModelNameSpan.textContent = modelName;
        
        // Mettre à jour visuellement les cartes
        const modelCards = document.querySelectorAll('.model-card');
        modelCards.forEach(card => {
            const cardSelectBtn = card.querySelector('.select-model-btn');
            if (cardSelectBtn && cardSelectBtn.getAttribute('data-model') === modelName) {
                card.classList.add('active');
                cardSelectBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sélectionné';
                cardSelectBtn.classList.remove('btn-primary');
                cardSelectBtn.classList.add('btn-success');
            } else {
                card.classList.remove('active');
                if (cardSelectBtn) {
                    cardSelectBtn.innerHTML = '<i class="bi bi-check-circle"></i> Sélectionner';
                    cardSelectBtn.classList.remove('btn-success');
                    cardSelectBtn.classList.add('btn-primary');
                }
            }
        });
        
        // Charger les paramètres du modèle
        loadModelParameters(modelName);
        
        // Sauvegarder la sélection dans le stockage local
        localStorage.setItem('selected_model', modelName);
    }
    
    // Fonction pour charger les paramètres d'un modèle
    async function loadModelParameters(modelName) {
        console.log("Chargement des paramètres pour le modèle:", modelName);
        
        try {
            // Essayer de charger les paramètres depuis l'API
            const response = await fetch(`/api/models/${modelName}/params`);
            
            let modelParameters;
            
            if (response.ok) {
                modelParameters = await response.json();
                console.log("Paramètres chargés depuis l'API:", modelParameters);
            } else {
                console.warn(`Impossible de charger les paramètres depuis l'API pour ${modelName}, utilisation des valeurs par défaut ou locales`);
                
                // Paramètres par défaut
                modelParameters = {
                    temperature: 0.7,
                    top_p: 0.9,
                    max_tokens: 800,
                    context_size: 4096,
                    top_k: 40,
                    repeat_penalty: 1.1,
                    presence_penalty: 0,
                    frequency_penalty: 0,
                    mirostat: 0,
                    seed: -1
                };
                
                // Essayer de charger les paramètres sauvegardés dans le stockage local
                const savedParams = localStorage.getItem(`model_params_${modelName}`);
                if (savedParams) {
                    try {
                        const params = JSON.parse(savedParams);
                        console.log("Paramètres chargés depuis localStorage:", params);
                        Object.assign(modelParameters, params);
                    } catch (error) {
                        console.error("Erreur lors du chargement des paramètres sauvegardés:", error);
                    }
                }
            }
            
            // Appliquer les paramètres aux sliders et inputs
            Object.keys(modelParameters).forEach(param => {
                const slider = document.getElementById(`${param}-slider`);
                const input = document.getElementById(`${param}-input`);
                const valueDisplay = document.getElementById(`${param}-value`);
                
                if (slider && modelParameters[param] !== undefined) {
                    slider.value = modelParameters[param];
                    if (valueDisplay) {
                        valueDisplay.textContent = modelParameters[param];
                    }
                } else if (input && modelParameters[param] !== undefined) {
                    input.value = modelParameters[param];
                }
            });
            
        } catch (error) {
            console.error("Erreur lors du chargement des paramètres du modèle:", error);
        }
    }
    
    // Fonction pour afficher les informations détaillées d'un modèle
    async function showModelInfo(modelName) {
        console.log("Affichage des informations pour le modèle:", modelName);
        
        try {
            const response = await fetch(`/api/models/${modelName}`);
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("Informations du modèle reçues:", data);
            
            // Créer une fenêtre modale pour afficher les informations
            const modalHtml = `
                <div class="modal fade" id="modelInfoModal" tabindex="-1" aria-labelledby="modelInfoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modelInfoModalLabel">Informations sur ${modelName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Détails du modèle</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-striped">
                                            <tr>
                                                <td><strong>Nom :</strong></td>
                                                <td>${data.model || modelName}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Taille :</strong></td>
                                                <td>${data.size ? (data.size / (1024 * 1024 * 1024)).toFixed(2) + ' GB' : 'Inconnue'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Digeste :</strong></td>
                                                <td><code>${data.digest || 'Non disponible'}</code></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Famille :</strong></td>
                                                <td>${data.family || data.details?.family || 'Inconnue'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Paramètres :</strong></td>
                                                <td>${data.parameters || data.details?.parameter_size || 'Inconnus'}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Format :</strong></td>
                                                <td>${data.format || data.details?.format || 'Inconnu'}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                ${data.modelfile ? `
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Modelfile</h6>
                                    </div>
                                    <div class="card-body">
                                        <pre class="bg-light p-3 rounded"><code>${data.modelfile}</code></pre>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            // Afficher la modale en utilisant Bootstrap
            const modal = new bootstrap.Modal(document.getElementById('modelInfoModal'));
            modal.show();
            
            // Nettoyer après la fermeture
            document.getElementById('modelInfoModal').addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalContainer);
            });
            
        } catch (error) {
            console.error("Erreur lors de la récupération des informations du modèle:", error);
            alert("Impossible de récupérer les informations du modèle. Vérifiez qu'Ollama est bien en cours d'exécution.");
        }
    }
    
    // Fonction pour supprimer un modèle
    async function deleteModel(modelName) {
        console.log("Suppression du modèle:", modelName);
        
        // Demander confirmation
        if (!confirm(`Êtes-vous sûr de vouloir supprimer le modèle "${modelName}" ?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/models/${modelName}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const result = await response.json();
            console.log("Résultat de la suppression:", result);
            
            if (result.success) {
                // Supprimer de la liste locale
                availableModels = availableModels.filter(model => (model.name || model.model) !== modelName);
                
                // Mettre à jour l'interface
                renderModelsList(availableModels);
                
                // Si le modèle supprimé était sélectionné, réinitialiser la sélection
                if (currentModel === modelName) {
                    currentModel = "";
                    document.getElementById('selected-model').value = "";
                    document.getElementById('current-model-name').textContent = "-";
                }
                
                // Supprimer les paramètres stockés localement
                localStorage.removeItem(`model_params_${modelName}`);
                
                // Afficher un message de succès
                alert(`Le modèle "${modelName}" a été supprimé avec succès.`);
            } else {
                throw new Error(result.message || "Échec de la suppression pour une raison inconnue");
            }
            
        } catch (error) {
            console.error("Erreur lors de la suppression du modèle:", error);
            alert(`Erreur lors de la suppression du modèle: ${error.message}`);
        }
    }
    
    // Gestionnaire pour le formulaire de téléchargement de modèle
    const pullModelForm = document.getElementById('pull-model-form');
    if (pullModelForm) {
        pullModelForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("Formulaire de téléchargement soumis");
            
            const modelName = document.getElementById('model-name-input').value.trim();
            const modelTag = document.getElementById('model-tag-input').value.trim();
            
            if (!modelName) {
                alert("Veuillez entrer un nom de modèle.");
                return;
            }
            
            // Construire le nom complet du modèle
            const fullModelName = modelTag ? `${modelName}:${modelTag}` : modelName;
            console.log("Téléchargement du modèle:", fullModelName);
            
            // Afficher le conteneur de progression
            const progressContainer = document.getElementById('pull-progress-container');
            const progressBar = document.getElementById('pull-progress-bar');
            const progressDetails = document.getElementById('pull-progress-details');
            const pullStatus = document.getElementById('pull-model-status');
            
            if (progressContainer) progressContainer.classList.remove('d-none');
            if (pullStatus) pullStatus.textContent = `Téléchargement de ${fullModelName} en cours...`;
            if (progressBar) progressBar.style.width = '0%';
            if (progressDetails) progressDetails.textContent = 'Initialisation du téléchargement...';
            
            try {
                const response = await fetch(`/api/models/pull`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: fullModelName }),
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                // Traiter la réponse en streaming
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // Variables pour suivre la progression
                let totalSizeBytes = 0;
                let downloadedBytes = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        console.log("Téléchargement terminé");
                        break;
                    }
                    
                    // Décoder le chunk
                    const chunk = decoder.decode(value, { stream: true });
                    console.log("Chunk reçu:", chunk);
                    
                    const lines = chunk.split('\n').filter(line => line.trim());
                    
                    // Traiter chaque ligne de la réponse streaming
                    for (const line of lines) {
                        try {
                            // Vérifier si la ligne commence par "data: "
                            const dataLine = line.startsWith('data: ') ? line.substring(6) : line;
                            
                            const data = JSON.parse(dataLine);
                            console.log("Données de progression:", data);
                            
                            // Mettre à jour l'interface utilisateur avec les informations de progression
                            if (data.status) {
                                if (progressDetails) progressDetails.textContent = data.status;
                            }
                            
                            if (data.total && data.completed !== undefined) {
                                // Mettre à jour les totaux
                                totalSizeBytes = data.total;
                                downloadedBytes = data.completed;
                                
                                // Calculer le pourcentage de progression
                                const progressPercent = totalSizeBytes > 0 
                                    ? Math.min(100, Math.round((downloadedBytes / totalSizeBytes) * 100)) 
                                    : 0;
                                
                                // Mettre à jour la barre de progression
                                if (progressBar) progressBar.style.width = `${progressPercent}%`;
                                
                                // Formater les tailles pour l'affichage
                                const downloadedGB = (downloadedBytes / (1024 * 1024 * 1024)).toFixed(2);
                                const totalGB = (totalSizeBytes / (1024 * 1024 * 1024)).toFixed(2);
                                
                                // Mettre à jour les détails de progression
                                if (progressDetails) {
                                    progressDetails.textContent = `${downloadedGB} GB / ${totalGB} GB (${progressPercent}%)`;
                                }
                            }
                        } catch (parseError) {
                            console.warn("Impossible de parser la ligne JSON:", parseError);
                        }
                    }
                }
                
                // Téléchargement terminé
                if (pullStatus) pullStatus.textContent = `Téléchargement de ${fullModelName} terminé!`;
                if (progressBar) progressBar.style.width = '100%';
                if (progressDetails) progressDetails.textContent = 'Téléchargement terminé avec succès';
                
                // Attendre un moment puis masquer le conteneur de progression
                setTimeout(() => {
                    if (progressContainer) progressContainer.classList.add('d-none');
                    
                    // Recharger la liste des modèles
                    loadModels();
                    
                    // Vider les champs du formulaire
                    document.getElementById('model-name-input').value = '';
                    document.getElementById('model-tag-input').value = '';
                }, 3000);
                
            } catch (error) {
                console.error("Erreur lors du téléchargement du modèle:", error);
                
                if (pullStatus) pullStatus.textContent = `Erreur: ${error.message}`;
                if (progressBar) {
                    progressBar.classList.remove('bg-primary');
                    progressBar.classList.add('bg-danger');
                }
                if (progressDetails) progressDetails.textContent = 'Échec du téléchargement. Vérifiez le nom du modèle et la connexion à Ollama.';
                
                // Ne pas masquer le conteneur pour que l'utilisateur puisse voir l'erreur
            }
        });
    }
    
    // Gestionnaire pour le formulaire de paramètres
    const modelParametersForm = document.getElementById('model-parameters-form');
    if (modelParametersForm) {
        modelParametersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log("Formulaire de paramètres soumis");
            
            const modelName = document.getElementById('selected-model').value;
            if (!modelName) {
                alert("Veuillez d'abord sélectionner un modèle.");
                return;
            }
            
            // Récupérer tous les paramètres du formulaire
            const formData = new FormData(this);
            const parameters = {};
            
            for (const [key, value] of formData.entries()) {
                // Convertir en nombre si nécessaire
                parameters[key] = isNaN(value) ? value : Number(value);
            }
            
            console.log("Paramètres à sauvegarder:", parameters);
            
            // Sauvegarder les paramètres dans le stockage local pour plus de robustesse
            localStorage.setItem(`model_params_${modelName}`, JSON.stringify(parameters));
            
            // Envoyer les paramètres au serveur
            saveModelParameters(modelName, parameters);
        });
    }
    
    // Fonction pour sauvegarder les paramètres du modèle
    
    async function saveModelParameters(modelName, parameters) {
        console.log("Sauvegarde des paramètres pour", modelName, parameters);
        
        try {
            const response = await fetch(`/api/models/${modelName}/params`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(parameters),
            });
            
            console.log("Réponse reçue:", response);
            
            // Lire le texte de la réponse pour débogage
            const responseText = await response.text();
            console.log("Texte de la réponse:", responseText);
            
            let success = false;
            let message = "";
            
            if (response.ok) {
                try {
                    // Convertir le texte en JSON
                    const data = JSON.parse(responseText);
                    console.log("Données JSON:", data);
                    success = data.success || true;
                    message = data.message || "Paramètres sauvegardés avec succès";
                } catch (parseError) {
                    console.error("Erreur de parsing JSON:", parseError);
                    message = "Erreur lors du parsing de la réponse";
                    // La sauvegarde dans localStorage a déjà été faite plus haut,
                    // donc on peut considérer que c'est un succès partiel
                    success = true;
                }
            } else {
                message = `Erreur HTTP: ${response.status} - ${responseText}`;
                // Toujours considérer comme succès partiel si sauvegardé localement
                success = true;
            }
            
            // Afficher un message de succès ou d'erreur
            const saveBtn = document.getElementById('save-parameters-btn');
            const originalText = saveBtn.innerHTML;
            
            if (success) {
                saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sauvegardé!';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-success');
            } else {
                saveBtn.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Erreur!';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-danger');
                console.error("Erreur lors de la sauvegarde:", message);
            }
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('btn-success', 'btn-danger');
                saveBtn.classList.add('btn-primary');
            }, 2000);
            
            return success;
            
        } catch (error) {
            console.error("Exception lors de la sauvegarde des paramètres:", error);
            
            // Afficher un message d'erreur
            const saveBtn = document.getElementById('save-parameters-btn');
            if (saveBtn) {
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Erreur!';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-danger');
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.classList.remove('btn-danger');
                    saveBtn.classList.add('btn-primary');
                }, 2000);
            }
            
            // Même si l'API échoue, les paramètres ont été sauvegardés localement
            return false;
        }
    }
    
    // Gestionnaire pour réinitialiser les paramètres
    const resetParametersBtn = document.getElementById('reset-parameters-btn');
    if (resetParametersBtn) {
        resetParametersBtn.addEventListener('click', function() {
            console.log("Réinitialisation des paramètres");
            
            const modelName = document.getElementById('selected-model').value;
            if (!modelName) {
                alert("Veuillez d'abord sélectionner un modèle.");
                return;
            }
            
            // Confirmer la réinitialisation
            if (!confirm("Êtes-vous sûr de vouloir réinitialiser tous les paramètres aux valeurs par défaut ?")) {
                return;
            }
            
            // Supprimer les paramètres sauvegardés
            localStorage.removeItem(`model_params_${modelName}`);
            
            // Réinitialiser les sliders et inputs
            const defaultParameters = {
                temperature: 0.7,
                top_p: 0.9,
                max_tokens: 800,
                context_size: 4096,
                top_k: 40,
                repeat_penalty: 1.1,
                presence_penalty: 0,
                frequency_penalty: 0,
                mirostat: 0,
                seed: -1
            };
            
            Object.keys(defaultParameters).forEach(param => {
                const slider = document.getElementById(`${param}-slider`);
                const input = document.getElementById(`${param}-input`);
                const valueDisplay = document.getElementById(`${param}-value`);
                
                if (slider) {
                    slider.value = defaultParameters[param];
                    if (valueDisplay) {
                        valueDisplay.textContent = defaultParameters[param];
                    }
                } else if (input) {
                    input.value = defaultParameters[param];
                }
            });
            
            // Envoyer la réinitialisation au serveur
            saveModelParameters(modelName, defaultParameters);
        });
    }
    
    // Gestionnaire pour le bouton d'actualisation des modèles
    const refreshModelsBtn = document.getElementById('refresh-models-btn');
    if (refreshModelsBtn) {
        refreshModelsBtn.addEventListener('click', function() {
            console.log("Actualisation des modèles");
            loadModels();
        });
    }
    
    // Gestionnaire pour le bouton de vérification de la connexion Ollama
    const checkOllamaConnectionBtn = document.getElementById('check-ollama-connection');
    if (checkOllamaConnectionBtn) {
        checkOllamaConnectionBtn.addEventListener('click', function() {
            console.log("Vérification de la connexion Ollama");
            loadModels();
        });
    }
    
    // Fonction pour mettre à jour les informations système
    async function updateSystemInfo() {
        console.log("Mise à jour des informations système");
        
        try {
            const response = await fetch('/api/system_info');
            
            if (response.ok) {
                const data = await response.json();
                console.log("Informations système reçues:", data);
                updateSystemInfoDisplay(data);
            } else {
                console.error("Erreur lors de la récupération des informations système:", response.status);
            }
        } catch (error) {
            console.error("Exception lors de la mise à jour des informations système:", error);
        }
    }
    
    // Gestionnaire pour le bouton d'actualisation des informations système
    const refreshSystemInfoBtn = document.getElementById('refresh-system-info');
    if (refreshSystemInfoBtn) {
        refreshSystemInfoBtn.addEventListener('click', function() {
            console.log("Actualisation des informations système");
            updateSystemInfo();
        });
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM chargé, initialisation...");
        
        // Charger les modèles dès le chargement de la page
        loadModels();
        
        // Mettre à jour les informations système
        updateSystemInfo();
        
        // Restaurer le modèle sélectionné précédemment
        const savedModel = localStorage.getItem('selected_model');
        if (savedModel) {
            console.log("Restauration du modèle sélectionné précédemment:", savedModel);
            currentModel = savedModel;
            
            const selectedModelInput = document.getElementById('selected-model');
            if (selectedModelInput) selectedModelInput.value = savedModel;
            
            const currentModelNameSpan = document.getElementById('current-model-name');
            if (currentModelNameSpan) currentModelNameSpan.textContent = savedModel;
        }
    });
});
{% endblock %}